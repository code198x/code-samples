REM *** LESSON 58: PUZZLE GAME (SOKOBAN-STYLE) ***
REM WOW Moment
NEW
10 REM *** SOKOBAN ***
20 PRINT CHR$(147)
30 POKE 53280,11:POKE 53281,12
40 REM *** INIT ***
50 LV=1:MV=0
60 DIM LX(3):DIM LY(3):DIM BX(3):DIM BY(3)
70 DIM TX(3):DIM TY(3):DIM UN(20,4)
80 REM *** LEVEL DATA ***
90 ON LV GOTO 150,200,250
100 REM
150 REM *** LEVEL 1 ***
160 PX=2:PY=2:BX(1)=4:BY(1)=4:TX(1)=7:TY(1)=7:NB=1:GOTO 300
170 REM
200 REM *** LEVEL 2 ***
210 PX=2:PY=2:BX(1)=4:BY(1)=3:BX(2)=5:BY(2)=5
220 TX(1)=7:TY(1)=2:TX(2)=7:TY(2)=7:NB=2:GOTO 300
230 REM
250 REM *** LEVEL 3 ***
260 PX=1:PY=4:BX(1)=3:BY(1)=2:BX(2)=5:BY(2)=4:BX(3)=3:BY(3)=6
270 TX(1)=7:TY(1)=1:TX(2)=7:TY(2)=4:TX(3)=7:TY(3)=7:NB=3
280 REM
300 REM *** MAIN LOOP ***
310 PRINT CHR$(19)
320 PRINT "LEVEL";LV;" MOVES:";MV;" U=UNDO"
330 PRINT
340 REM *** DRAW GRID ***
350 FOR Y=1 TO 8
360 FOR X=1 TO 8
370 C$="."
380 FOR I=1 TO NB
390 IF X=TX(I) AND Y=TY(I) THEN C$="O"
400 IF X=BX(I) AND Y=BY(I) THEN C$="B"
410 IF X=BX(I) AND Y=BY(I) AND X=TX(I) AND Y=TY(I) THEN C$=CHR$(18)+"B"+CHR$(146)
420 NEXT I
430 IF X=PX AND Y=PY THEN C$="P"
440 PRINT C$;
450 NEXT X:PRINT:NEXT Y
460 PRINT
470 PRINT "WASD=MOVE U=UNDO"
480 REM *** INPUT ***
490 GET K$:IF K$="" THEN GOTO 300
500 REM *** UNDO ***
510 IF K$="U" AND MV>0 THEN PX=UN(MV,1):PY=UN(MV,2):BX(UN(MV,4))=UN(MV,3):BY(UN(MV,4))=UN(MV,4):MV=MV-1:GOTO 300
520 REM *** MOVEMENT ***
530 NX=PX:NY=PY
540 IF K$="W" THEN NY=NY-1
550 IF K$="S" THEN=NY+1
560 IF K$="A" THEN NX=NX-1
570 IF K$="D" THEN NX=NX+1
580 IF NX<1 OR NX>8 OR NY<1 OR NY>8 THEN GOTO 300
590 REM *** BOX COLLISION ***
600 BI=0
610 FOR I=1 TO NB
620 IF NX=BX(I) AND NY=BY(I) THEN BI=I
630 NEXT I
640 IF BI=0 THEN PX=NX:PY=NY:GOTO 300
650 REM *** PUSH BOX ***
660 NBX=BX(BI)+(NX-PX):NBY=BY(BI)+(NY-PY)
670 IF NBX<1 OR NBX>8 OR NBY<1 OR NBY>8 THEN GOTO 300
680 FOR I=1 TO NB
690 IF I<>BI AND NBX=BX(I) AND NBY=BY(I) THEN GOTO 300
700 NEXT I
710 REM *** SAVE UNDO ***
720 MV=MV+1
730 UN(MV,1)=PX:UN(MV,2)=PY:UN(MV,3)=BX(BI):UN(MV,4)=BY(BI):UN(MV,5)=BI
740 REM *** EXECUTE PUSH ***
750 BX(BI)=NBX:BY(BI)=NBY:PX=NX:PY=NY
760 REM *** WIN CHECK ***
770 W=0
780 FOR I=1 TO NB
790 FOR J=1 TO NB
800 IF BX(I)=TX(J) AND BY(I)=TY(J) THEN W=W+1
810 NEXT J:NEXT I
820 IF W=NB THEN GOSUB 1000
830 GOTO 300
840 REM
1000 REM *** LEVEL COMPLETE ***
1010 PRINT CHR$(147)
1020 POKE 53280,5:POKE 53281,13
1030 PRINT
1040 PRINT "  LEVEL";LV;"COMPLETE!"
1050 PRINT
1060 PRINT "  MOVES:";MV
1070 FOR I=1 TO 2000:NEXT I
1080 LV=LV+1
1090 IF LV>3 THEN PRINT:PRINT "  ALL LEVELS DONE!":FOR I=1 TO 3000:NEXT I:END
1100 MV=0:GOTO 90